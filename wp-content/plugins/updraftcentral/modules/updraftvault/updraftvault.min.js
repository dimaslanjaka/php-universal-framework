function UpdraftCentral_PrevNext_Paginator(e,r,t){var a,n=this,i=t,l="",p=r.last_marker;function s(){n.element.trigger("page_change",l,p),jQuery.isFunction(i)&&i(l,p)}r.is_paged&&(0<r.prev_key.length||0<r.next_key.length)&&(a=e,n.element=jQuery(UpdraftCentral.template_replace("updraftvault-prevnext-paginator",{})),0==r.prev_key.length&&(n.element.find("a.page_prev").parent("li").hide(),n.element.find('li:contains("|")').hide()),0==r.next_key.length&&(n.element.find("a.page_next").parent("li").hide(),n.element.find('li:contains("|")').hide()),n.element.appendTo(a),n.element.on("click","a",function(e){e.preventDefault(),jQuery(this).hasClass("page_prev")?(markers=p.split(","),l=markers[markers.length-1],p=p.replace(","+l,""),s()):jQuery(this).hasClass("page_next")&&(l=r.next_key,p+=","+r.prev_key,s())})),this.page_change=function(e){i=e}}function UpdraftCentral_UpdraftVault_Management(){var g,n,i,l=this;function p(a,e){var r=a.find(".updraftcentral_updraftvault_paginator");if(0===r.length){var t=a.find(".updraftcentral_row_extracontents");r=jQuery('<div class="updraftcentral_updraftvault_paginator"></div>').appendTo(t)}else r.empty();new UpdraftCentral_PrevNext_Paginator(r,e).page_change(function(e,r){var t={bucket:n,prefix:i,marker_key:e,last_marker:r,per_page:a.find(".updraftcentral_updraftvault_header .per_page").val()};l.browse_files(a,t).then(function(e){void 0!==e.paging&&p(a,{prev_key:e.paging.prev_key,next_key:e.paging.next_key,is_paged:e.paging.is_paged,last_marker:e.paging.last_marker})})})}function v(e,r){if(0===e)return"0 Bytes";var t=r||3,a=Math.floor(Math.log(e)/Math.log(1e3));return parseFloat((e/Math.pow(1e3,a)).toFixed(t))+" "+["Bytes","KB","MB","GB","TB"][a]}function s(e){UpdraftCentral.set_loading(e.container),void 0!==e.aws_request&&e.container.before('<div class="updraftcentral_spinner"></div>')}function d(e){var r=jQuery.Deferred();return UpdraftCentral.done_loading(e.container,e.html).then(function(){void 0!==e.aws_request&&e.container.parent().children(".updraftcentral_spinner").remove(),r.resolve()}),r.promise()}function u(e){var r;if("string"!=typeof e&&e&&e.hasOwnProperty("values")&&(r=e.values,e=e.message),void 0===e&&console.log("UpdraftCentral: The 'translate_message' requires an object with the properties 'message' and 'values' if there's a variable"),!1===e)return"";var t=udclion.updraftvault[e];return void 0===t?(UpdraftCentral_Library.dialog.alert("<h2>"+udclion.error+"</h2><p>"+sprintf(udclion.updraftvault.translation_not_found_for,e)+"</p>"),null):void 0===r?t:sprintf(t,r)}jQuery("#updraftcentral_dashboard_existingsites").on("updraftcentral_dashboard_mode_set_updraftvault",function(){UpdraftCentral.register_row_clicker('.updraftcentral_updraftvault_table input[name="uc_updraftvault_check_all"]',function(e){var r=!1;jQuery(this).is(":checked")&&(r=!0),e.find(".updraftcentral_updraftvault_table input.check_item").each(function(){jQuery(this).prop("checked",r)})},!0,"change"),UpdraftCentral.register_row_clicker("select.per_page",function(r){if(r.find(".updraftcentral_updraftvault_rows.no-matched").is(":visible"))return!1;var e={bucket:n,prefix:i,per_page:r.find(".updraftcentral_updraftvault_header .per_page").val()};l.browse_files(r,e).then(function(e){void 0!==e.paging&&p(r,{prev_key:e.paging.prev_key,next_key:e.paging.next_key,is_paged:e.paging.is_paged,last_marker:e.paging.last_marker})})},!0,"change"),UpdraftCentral.register_row_clicker(".updraftcentral_site_updraftvault_action_btn",function(r){if(r.find(".updraftcentral_updraftvault_rows.no-matched").is(":visible"))return!1;switch(jQuery(this).data("action")){case"delete":var t={bucket:n,prefix:i,files:[]};r.find(".updraftcentral_updraftvault_table input.check_item:checked").each(function(){t.files.push(jQuery(this).data("key"))}),0<t.files.length?UpdraftCentral_Library.dialog.confirm("<h2>"+u("delete_files")+"</h2><p>"+u("delete_files_confirm")+"</p>",function(e){e&&l.delete_files(r,t)}):UpdraftCentral_Library.dialog.alert("<h2>"+u("empty_selection_header")+"</h2><p>"+u("select_files")+"</p>")}},!0),UpdraftCentral.register_row_clicker(".updraftcentral_site_browse_files",function(a){l.get_updraftvault_credentials(a).then(function(e){var r=function(e,r){var t={bucket:"",prefix:"",region:""};if(void 0!==e){var a=e.split("/");a.length&&(t.bucket=a[0],t.region=t.bucket.replace(r+"-",""),1<a.length&&(t.prefix=e.replace(t.bucket+"/","")+"/"))}return t}(e.path,e.key);AWS.config.update({accessKeyId:e.accesskey,secretAccessKey:e.secretkey,sessionToken:e.sessiontoken}),AWS.config.region=r.region,g=new AWS.S3,n=r.bucket,i=r.prefix;var t={bucket:r.bucket,prefix:r.prefix,per_page:10,marker_key:"",last_marker:""};l.get_updraftvault_filters(a),l.browse_files(a,t).then(function(e){void 0!==e.paging&&p(a,{prev_key:e.paging.prev_key,next_key:e.paging.next_key,is_paged:e.paging.is_paged,last_marker:e.paging.last_marker})})})},!0)}),this.browse_files=function(e,r){var t=jQuery.Deferred(),a=e.find(".updraftcentral_row_extracontents"),n=a.find(".updraftcentral_updraftvault_rows");0===n.length&&(n=jQuery('<div class="updraftcentral_updraftvault_rows"></div>').appendTo(a));var i={container:n,html:"",aws_request:!0};return s(i),function(o){var c=jQuery.Deferred();void 0===o.per_page&&(o.per_page=10);void 0===o.marker_key&&(o.marker_key="");void 0===o.last_marker&&(o.last_marker="");var e={Bucket:o.bucket,Delimiter:"/",Marker:o.marker_key,MaxKeys:o.per_page,Prefix:o.prefix};return g.listObjects(e,function(e,r){if(e)c.reject({error:!0,message:"general_error_response",values:[e.stack]});else{for(var t,a,n,i,l,p=o.marker_key,s="",d=!0,u=[],f=r.Contents,_=0;_<f.length;_++)n=(a=f[_].Key).replace(o.prefix,""),i=v(f[_].Size,2),l={Bucket:o.bucket,Key:a},o.prefix!==a&&u.push({key:a,file_name:n,size:i,download_link:g.getSignedUrl("getObject",l)});u.length&&(r.IsTruncated?s=r.NextMarker:0===p.length&&(d=!1)),t={prev_key:p,next_key:s,is_paged:d,last_marker:o.last_marker},u.length?c.resolve({files:u,data:r,paging:t}):c.resolve({error:!1,message:"files_not_found",values:[]})}}),c.promise()}(r).then(function(e){i.html=UpdraftCentral.template_replace("updraftvault-updraftvault-row",e),void 0!==e.message&&(i.html=u(e)),i.response=e}).fail(function(e){UpdraftCentral_Library.dialog.alert("<h2>"+u("browse_failed_header")+"</h2><p>"+u(e)+"</p>"),i.response=e}).always(function(e){void 0===e&&(e=i.response),d(i).then(function(){void 0!==e.files?jQuery.isArray(e.files)&&jQuery(".updraftcentral_updraftvault_rows").removeClass("no-matched"):void 0!==e.message&&"files_not_found"===e.message&&jQuery(".updraftcentral_updraftvault_rows").addClass("no-matched"),t.resolve(e)})}),t.promise()},this.delete_files=function(t,a){var e=t.find(".updraftcentral_row_extracontents"),r=e.find(".updraftcentral_updraftvault_rows");0===r.length&&(r=jQuery('<div class="updraftcentral_updraftvault_rows"></div>').appendTo(e));var n={container:r,html:"",aws_request:!0};s(n),function(e){var t=jQuery.Deferred();files=[];for(var r=0;r<e.files.length;r++)key=e.files[r],files.push({Key:key});var a={Bucket:e.bucket,Delete:{Objects:files}};return g.deleteObjects(a,function(e,r){e?t.reject({error:!0,message:"delete_error",values:[e.stack]}):t.resolve({error:!1,message:"delete_success",values:[]})}),t.promise()}(a).then(function(e){var r=e;l.browse_files(t,a).then(function(e){void 0!==e.paging&&p(t,{prev_key:e.paging.prev_key,next_key:e.paging.next_key,is_paged:e.paging.is_paged,last_marker:e.paging.last_marker}),UpdraftCentral_Library.dialog.alert("<h2>"+u("delete_success_header")+"</h2><p>"+u(r)+"</p>")})}).fail(function(e){UpdraftCentral_Library.dialog.alert("<h2>"+u("delete_failed_header")+"</h2><p>"+u(e)+"</p>"),d(n)})},this.get_updraftvault_filters=function(e){var r=jQuery.Deferred(),t=e.find(".updraftcentral_row_extracontents"),a=t.find(".updraftcentral_updraftvault_filters");0===a.length&&(a=jQuery('<div class="updraftcentral_updraftvault_filters"></div>').prependTo(t));var n={container:a,html:""};s(n);return n.html=UpdraftCentral.template_replace("updraftvault-updraftvault-filter",{paging:{per_page_options:[10,20,50,100,500,1e3]}}),d(n).then(function(){r.resolve()}),r.promise()},this.get_updraftvault_credentials=function(e){var t=jQuery.Deferred(),r=e.find(".updraftcentral_row_extracontents"),a=r.find(".updraftcentral_updraftvault_rows");0===a.length&&(a=jQuery('<div class="updraftcentral_updraftvault_rows"></div>').appendTo(r));var n={container:a,html:""};return s(n),UpdraftCentral.send_site_rpc("updraftvault.get_credentials",null,e,function(e,r){"ok"!==r||e.data.error?(UpdraftCentral_Library.dialog.alert("<h2>"+u("connection_error_header")+"</h2><p>"+u(e.data)+"</p>"),d(n),t.reject()):(n.html=UpdraftCentral.template_replace("updraftvault-updraftvault-row",e.data),d(n).then(function(){t.resolve(e.data)}))}),t.promise()}}jQuery(document).ready(function(){new UpdraftCentral_UpdraftVault_Management});