{"version":3,"sources":["gulp-jsdoc.js"],"names":["os","require","type","debug","tmp","setGracefulCleanup","jsdoc","config","done","files","jsdocConfig","arguments","length","undefined","JSON","stringify","file","callback","push","path","on","Promise","resolve","reject","jsdocConfigClone","parse","source","include","concat","Object","assign","errMsg","fancyLog","error","Error","tmpobj","fileSync","join","fs","writeFile","name","err","spawn","cmd","inkdocstrap","dirname","args","opts","template","templates","default","layoutFile","child","process","execPath","cwd","stdout","setEncoding","stderr","data","code","then","catch"],"mappings":"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","sourcesContent":["import map from \"map-stream\";\r\nimport tmp from \"tmp\";\r\nimport fs from \"fs\";\r\nimport path from \"path\";\r\nimport fancyLog from \"fancy-log\";\r\nimport beeper from \"beeper\";\r\nlet os = require(\"os\").type();\r\n\r\nlet debug = require(\"debug\")(\"gulp-jsdoc3\");\r\n\r\n// tmp is not deleting the file by default (https://github.com/raszi/node-tmp/issues/266)\r\ntmp.setGracefulCleanup();\r\n\r\n/**\r\n * @callback gulpDoneCallback\r\n */\r\n\r\n/**\r\n * A wrapper around jsdoc cli.\r\n *\r\n * This function collects all filenames. Then runs:\r\n * ```jsdoc -c config -t node_modules/ink-docstrap/template gulpFile1 gulpFile2```\r\n * @example\r\n * gulp.src(['README.md', 'src/*.js']), {read: false}).pipe(\r\n *     jsdoc(options, cb)\r\n * );\r\n *\r\n * @param {Object} [config=require('./jsdocConfig.json')]\r\n * @param {gulpDoneCallback} done\r\n * @returns {*|SignalBinding}\r\n */\r\nexport function jsdoc(config, done) {\r\n  let files = [];\r\n  let jsdocConfig;\r\n\r\n  // User just passed callback\r\n  if (arguments.length === 1 && typeof config === \"function\") {\r\n    done = config;\r\n    config = undefined;\r\n  }\r\n\r\n  // Prevent some errors\r\n  if (typeof done !== \"function\") {\r\n    done = function () {};\r\n  }\r\n\r\n  jsdocConfig = config || require(\"./jsdocConfig.json\");\r\n\r\n  debug(\"Config:\\n\" + JSON.stringify(jsdocConfig, undefined, 2));\r\n\r\n  return map(function (file, callback) {\r\n    files.push(file.path);\r\n    callback(null, file);\r\n  }).on(\"end\", function () {\r\n    // We use a promise to prevent multiple dones (normal cause error then close)\r\n    new Promise(function (resolve, reject) {\r\n      // We clone the config file so as to not affect the original\r\n      let jsdocConfigClone = JSON.parse(JSON.stringify(jsdocConfig));\r\n      // If the user has specified a source.include key, we append the\r\n      // gulp.src files to it.\r\n      if (jsdocConfigClone.source && jsdocConfigClone.source.include) {\r\n        jsdocConfigClone.source.include = jsdocConfigClone.source.include.concat(files);\r\n      } else {\r\n        jsdocConfigClone = Object.assign(jsdocConfigClone, { source: { include: files } });\r\n      }\r\n\r\n      if (jsdocConfigClone.source.include.length === 0) {\r\n        const errMsg = \"JSDoc Error: no files found to process\";\r\n        fancyLog.error(errMsg);\r\n        beeper();\r\n        reject(new Error(errMsg));\r\n        return;\r\n      }\r\n\r\n      const tmpobj = tmp.fileSync();\r\n      debug(\"Documenting files: \" + jsdocConfigClone.source.include.join(\" \"));\r\n      fs.writeFile(tmpobj.name, JSON.stringify(jsdocConfigClone), \"utf8\", function (err) {\r\n        // We couldn't write the temp file\r\n        /* istanbul ignore next */\r\n        if (err) {\r\n          reject(err);\r\n          return;\r\n        }\r\n\r\n        const spawn = require(\"child_process\").spawn,\r\n          cmd = require.resolve(\"jsdoc/jsdoc.js\"), // Needed to handle npm3 - find the binary anywhere\r\n          inkdocstrap = path.dirname(require.resolve(\"ink-docstrap\"));\r\n\r\n        let args = [\"-c\", tmpobj.name];\r\n\r\n        // Config + ink-docstrap if user did not specify their own layout or template\r\n        if (\r\n          !(jsdocConfigClone.opts && jsdocConfigClone.opts.template) &&\r\n          !(\r\n            jsdocConfigClone.templates &&\r\n            jsdocConfigClone.templates.default &&\r\n            jsdocConfigClone.templates.default.layoutFile\r\n          )\r\n        ) {\r\n          args = args.concat([\"-t\", inkdocstrap]);\r\n        }\r\n\r\n        debug(cmd + \" \" + args.join(\" \"));\r\n\r\n        const child =\r\n          os === \"Windows_NT\"\r\n            ? spawn(process.execPath, [cmd].concat(args), { cwd: process.cwd() })\r\n            : spawn(cmd, args, { cwd: process.cwd() }); // unix\r\n        child.stdout.setEncoding(\"utf8\");\r\n        child.stderr.setEncoding(\"utf8\");\r\n        /* istanbul ignore next */\r\n        child.stdout.on(\"data\", function (data) {\r\n          fancyLog(data);\r\n        });\r\n        /* istanbul ignore next */\r\n        child.stderr.on(\"data\", function (data) {\r\n          fancyLog.error(data);\r\n          beeper();\r\n        });\r\n        child.on(\"close\", function (code) {\r\n          if (code === 0) {\r\n            fancyLog(\r\n              \"Documented \" +\r\n                jsdocConfigClone.source.include.length +\r\n                \" \" +\r\n                (jsdocConfigClone.source.include.length === 1 ? \"file!\" : \"files!\")\r\n            );\r\n            resolve();\r\n          } else {\r\n            fancyLog.error(\"JSDoc returned with error code: \" + code);\r\n            beeper();\r\n            reject(new Error(\"JSDoc closed with error code: \" + code));\r\n          }\r\n        });\r\n        child.on(\"error\", function (error) {\r\n          fancyLog.error(\"JSDoc Error: \" + error);\r\n          beeper();\r\n          reject(new Error(error));\r\n        });\r\n      });\r\n    })\r\n      .then((data) => done(undefined, data))\r\n      .catch((err) => done(err));\r\n  });\r\n}\r\n"],"file":"gulp-jsdoc.js"}