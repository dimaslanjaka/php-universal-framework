var socket=null,user_id=$.user.get("id"),thumber=$(".text-bar__thumb"),scrollTop=$(window).scrollTop();function Message(conversation,lastSentMessages,textbar,textForm){return{currentText:"",room_url:textForm.attr("action"),init:function(){var base=this;this.send()},send:function(){var base=this;textForm.submit((function(event){event.preventDefault(),setTimeout(()=>{base.createGroup(),base.saveText(),""!=base.currentText&&(base.createMessage(),base.scrollDown())},500)}))},saveText:function(){var base=this;this.currentText=textbar.val(),textbar.val("")},createMessage:function(){var base=this;lastSentMessages.append($("<div/>").addClass("message").text(this.currentText))},createGroup:function(){$(".messages:last-child").hasClass("messages--received")&&(conversation.append($("<div/>").addClass("messages messages--sent")),lastSentMessages=$(".messages--sent:last-child"))},scrollDown:function(){var base=this;conversation.stop().animate({scrollTop:conversation[0].scrollHeight},500)}}}function fetch_chat_users(jquery_this){$.ajax({url:"/user",method:"post",data:{status:!0},success:function(res){if(res.hasOwnProperty("users")){res=res.users;var html="";for(let index=0;index<res.length;index++){const user=res[index];if(user){var offline="offline"==user.status.text.toLowerCase(),indicator=offline?"danger":"success";offline||(html+=`<li class="p-2">\n        <a href="#from" data-user="${user.id}" class="d-flex justify-content-between">\n          <img src="/assets/img/avatar.png" width="100px" height="100px" alt="avatar" class="avatar rounded-circle d-flex align-self-center mr-2 z-depth-1">\n          <div class="text-small">\n            <strong>${user.display_name}</strong>\n            <p class="last-message text-muted">Last Message</p>\n          </div>\n          <div class="chat-footer">\n            <p class="text-smaller text-muted mb-0">${user.status.last_online}</p>\n            <span class="badge badge-${indicator} float-right">${user.status.text}</span>\n          </div>\n        </a>\n      </li>\n      <div data-chatscreen="${user.id}" class="pb-3 pt-3"></div>\n      `),index==res.length-1&&""!=html&&($("#users").html(html),$("[data-chatscreen]").slideUp())}}}else console.error("fetch user failed")}})}function socket_start(host,callback){var isEventSource;if(host){if(console.log("socket started"),socket instanceof EventSource||socket||(socket=new EventSource(host)),socket)try{socket.onopen=function(msg){},socket.onmessage=function(msg){var data=JSON.parse(msg.data);data&&data.length&&"function"==typeof callback&&callback(data)},socket.onclose=function(msg){console.log({closed:socket,msg:msg})}}catch(ex){console.log("error",ex)}}else console.error("host must be defined")}function socket_stop(){socket instanceof EventSource&&(socket.close(),socket=null)}$(document).ready((function(){$("#ModalChat").on("shown.bs.modal",(function(e){var modal;fetch_chat_users($(this)),console.log("chat opened")})),$("#ModalChat").on("hidden.bs.modal",(function(e){socket_stop()})),$(document).on("click","[data-user]",(function(e){e.preventDefault();var current_user_id=$.user.get("id"),id=$(this).data("user"),room_url=`/chat/room?from=${current_user_id}&to=${id}`,uid_length=10,uid=Math.round(Math.pow(36,11)-Math.random()*Math.pow(36,10)).toString(36).slice(1),chat_html=`\n    <div class="screen">\n      <div class="conversation" data-chat="${id}">\n        <div style="display:none">\n          <div class="messages messages--received">\n            <div class="message">This is an example chat message</div>\n          </div>\n          <div class="messages messages--sent">\n            <div class="message">Try to type</div>\n          </div>\n          <div class="messages messages--received">\n            <div class="message">Enjoy!</div>\n          </div>\n        </div>\n      </div>\n      <div class="text-bar">\n        <form class="text-bar__field" method="post" action="${room_url}" id="form-message-${id}" data-callback="">\n          <input name="chat_message" type="text" placeholder="Type to message" />\n          <input type="hidden" name="send" value="${uid}" />\n        </form>\n        <div class="text-bar__thumb" id="iconPicker-${id}">\n          <div class="thumb"><i class="fad fa-envelope"></i></div>\n        </div>\n      </div>\n    </div>\n  `,chat_screen=$('[data-chatscreen="'+id+'"]'),chat_room=[],other_chats=$("[data-chatscreen]").not('[data-chatscreen="'+id+'"]');function fetch_chat(){var newMessage;chat_screen.length&&(chat_screen.html(chat_html),Object.create(Message($(".conversation"),$(".messages--sent:last-child"),$(".text-bar__field input"),$('[id^="form-message"]'))).init(),socket_stop(),socket_start(room_url,(function(chat){var reInsert=!1;for(let index=0;index<chat.length;index++){const msg=chat[index];chat_room.hasOwnProperty(msg.chat_message_id)||(chat_room[msg.chat_message_id]=msg.html,reInsert=!0),index==chat.length-1&&$('[data-chat="'+id+'"]').html(chat_room.join(""))}})),chat_screen.slideDown())}other_chats.length?other_chats.slideUp("slow",null,(function(){$(this).html(""),fetch_chat()})):fetch_chat()})),$(document).on("submit",'form[id^="form-message"]',(function(e){e.preventDefault()}))})),document.location.search.match(/type=embed/gi)&&window.parent.postMessage("resize","*");$(document).ready((function(){$("#ModalHistory").on("shown.bs.modal",(function(e){var modal=$(this);$.ajax({url:"/user",method:"post",data:{history:!0},success:function(array){var content="";if(array.length)for(let index=0;index<array.length;index++){var e=array[index],build;if(e)e.price=framework().rp(e.price,null),content+=`<div><div class="separator">${e.date}</div> Buy <b>${e.name}</b> to <b>${e.msisdn}</b> for <b>${e.price}</b></div>`,console.log(e),index==array.length-1&&modal.find(".modal-body").html(content)}}})}))}));