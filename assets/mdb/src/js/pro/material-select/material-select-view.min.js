import MaterialSelectViewRenderer from"./material-select-view-renderer";export default class MaterialSelectView{constructor(e,{options:t,properties:{id:i}}){this.properties={id:i,isMultiple:Boolean(e.attr("multiple")),isSearchable:Boolean(e.attr("searchable")),isRequired:Boolean(e.attr("required")),isEditable:Boolean(e.attr("editable"))},this.options=this._copyOptions(t),this.$nativeSelect=e,this.$selectWrapper=$('<div class="select-wrapper"></div>'),this.$materialOptionsList=$(`<ul id="select-options-${this.properties.id}" class="dropdown-content select-dropdown w-100 ${this.properties.isMultiple?"multiple-select-dropdown":""}"></ul>`),this.$materialSelectInitialOption=e.find("option:selected").text()||e.find("option:first").text()||"",this.$nativeSelectChildren=this.$nativeSelect.children("option, optgroup"),this.$materialSelect=$(`<input type="text" class="${this.options.defaultMaterialInput?"browser-default custom-select multi-bs-select select-dropdown form-control":"select-dropdown form-control"}" ${!this.options.validate&&'readonly="true"'} required="${this.options.validate?"true":"false"}" ${this.$nativeSelect.is(" :disabled")?"disabled":""} data-activates="select-options-${this.properties.id}" value=""/>`),this.$dropdownIcon=this.options.defaultMaterialInput?"":$('<span class="caret">&#9660;</span>'),this.$searchInput=null,this.$noSearchResultsInfo=$(`<li><span><i>${this.options.labels.noSearchResults}</i></span></li>`),this.$toggleAll=$(`<li class="select-toggle-all"><span><input type="checkbox" class="form-check-input"><label>${this.options.labels.selectAll}</label></span></li>`),this.$addOptionBtn=$('<i class="select-add-option fas fa-plus"></i>'),this.$mainLabel=this._jQueryFallback(this.$nativeSelect.next("label.mdb-main-label"),$(`label[for='${this.properties.id}']`)),this.$customTemplateParts=this._jQueryFallback(this.$nativeSelect.nextUntil("select",".mdb-select-template-part"),$(`[data-mdb-select-template-part-for='${this.properties.id}']`)),this.$btnSave=this.$nativeSelect.nextUntil("select",".btn-save"),this.$btnReset=$('<span class="reset-select-btn">&times;</span>'),this.$validFeedback=$(`<div class="valid-feedback">${this.options.labels.validFeedback}</div>`),this.$invalidFeedback=$(`<div class="invalid-feedback">${this.options.labels.invalidFeedback}</div>`),this.keyCodes={tab:9,enter:13,shift:16,alt:18,esc:27,space:32,end:35,home:36,arrowUp:38,arrowDown:40},this.renderer=new MaterialSelectViewRenderer(this),this.dropdown=null}static get isMobileDevice(){return/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)}get isMultiple(){return this.properties.isMultiple}get isSearchable(){return this.properties.isSearchable}get isRequired(){return this.properties.isRequired}get isEditable(){return this.properties.isEditable}get isDisabled(){return this.$nativeSelect.is(":disabled")}destroy(){this.renderer.destroy()}render(){this.renderer.render()}selectPreselectedOptions(e){if(this.isMultiple)this.$nativeSelect.find("option:selected:not(:disabled)").each((t,i)=>{const s=i.index;this.$materialOptionsList.find("li:not(.optgroup):not(.select-toggle-all)").eq(s).addClass("selected active").find(":checkbox").prop("checked",!0),e(s)});else{const t=this.$nativeSelect.find("option:selected").first(),i=this.$nativeSelect.find("option").index(t.get(0));t.get(0)&&"disabled"!==t.attr("disabled")&&e(i)}}bindResetButtonClick(e){this.$btnReset.on("click",t=>{t.preventDefault(),this.$nativeSelect.find('option[value=""][selected][disabled][data-mdb-novalue]').length||(this._toggleResetButton(!0),this.$materialSelect.val(this.isMultiple?[]:""),this.$materialSelect.trigger("close"),this.$mainLabel.removeClass("active"),this.$materialOptionsList.find("li.active, li.selected").removeClass("active").removeClass("selected"),this.$materialOptionsList.find('li[aria-selected="true"]').attr("aria-selected","false"),this.$materialOptionsList.find('input[type="checkbox"]').prop("checked",!1),e())})}bindAddNewOptionClick(){this.$addOptionBtn.on("click",this.renderer.addNewOption.bind(this.renderer))}bindMaterialSelectFocus(){this.$materialSelect.on("focus",e=>{const t=$(e.target);if(t.parent().addClass("active"),$("ul.select-dropdown").not(this.$materialOptionsList.get(0)).is(":visible")&&$("input.select-dropdown").trigger("close"),this.$mainLabel.addClass("active"),!this.$materialOptionsList.is(":visible")){const e=t.val(),i=this.$materialOptionsList.find("li").filter((function(){return $(this).text().toLowerCase()===e.toLowerCase()})).get(0);this._selectSingleOption(i)}this.isMultiple||this.$mainLabel.addClass("active")})}bindMaterialSelectClick(){this.$materialSelect.on("mousedown",e=>{3===e.which&&e.preventDefault()}),this.$materialSelect.on("click",e=>{e.stopPropagation(),this.$mainLabel.addClass("active"),this._updateDropdownScrollTop()})}bindMaterialSelectBlur(){this.$materialSelect.on("blur",e=>{const t=$(e.target);t.parent().removeClass("active"),this.isMultiple||this.isSearchable||t.trigger("close"),this.$materialOptionsList.find("li.selected").removeClass("selected")})}bindMaterialOptionsListTouchstart(){this.$materialOptionsList.on("touchstart",e=>e.stopPropagation())}bindMaterialSelectKeydown(){this.$materialSelect.on("keydown",e=>{const t=$(e.target),i=e.which===this.keyCodes.tab,s=e.which===this.keyCodes.arrowUp,l=e.which===this.keyCodes.arrowDown,a=e.which===this.keyCodes.enter,o=e.which===this.keyCodes.esc,n=l&&e.altKey,r=s&&e.altKey,c=e.which===this.keyCodes.home,h=e.which===this.keyCodes.end,d=e.which===this.keyCodes.space,p=this.$materialOptionsList.is(":visible");switch(!0){case i:return this._handleTabKey(t);case!p&&(a||n):case this.isMultiple&&!p&&(l||s):return t.trigger("open"),this._updateDropdownScrollTop();case p&&(o||r):return t.trigger("close");case!p&&(l||s):return this._handleClosedArrowUpDownKey(e.which);case p&&(l||s):return this._handleArrowUpDownKey(e.which);case p&&c:return this._handleHomeKey();case p&&h:return this._handleEndKey();case p&&(a||d):return this._handleEnterKey(t);default:return this._handleLetterKey(e)}})}bindMaterialSelectDropdownToggle(){this.$materialSelect.on("open",()=>this.$materialSelect.attr("aria-expanded","true")),this.$materialSelect.on("close",()=>this.$materialSelect.attr("aria-expanded","false"))}bindToggleAllClick(e){this.$toggleAll.on("click",t=>{const i=$(this.$toggleAll).find('input[type="checkbox"]').first(),s=Boolean($(i).prop("checked")),l=!s;$(i).prop("checked",!s),this.$materialOptionsList.find("li:not(.optgroup):not(.select-toggle-all)").each((t,i)=>{const s=$(i),a=s.find('input[type="checkbox"]');s.attr("aria-selected",l),l&&a.is(":checked")||!l&&!a.is(":checked")||$(i).is(":hidden")||$(i).is(".disabled")||(a.prop("checked",l),this.$nativeSelect.find("option").eq(t).prop("selected",l),s.toggleClass("active"),this._selectOption(i),e(t))}),this.$nativeSelect.data("stop-refresh",!0),this._triggerChangeOnNativeSelect(),this.$nativeSelect.removeData("stop-refresh"),t.stopPropagation()})}bindMaterialOptionMousedown(){this.$materialOptionsList.on("mousedown",e=>{const t=e.target,i=$(".modal-content").find(this.$materialOptionsList).length;i&&t.scrollHeight>t.offsetHeight&&e.preventDefault()})}bindMaterialOptionClick(e){this.$materialOptionsList.find("li:not(.optgroup)").not(this.$toggleAll).each((t,i)=>{$(i).on("click",s=>{s.stopPropagation(),this._toggleResetButton(!1);const l=$(i);if(l.hasClass("disabled")||l.hasClass("optgroup"))return;let a=!0;if(this.isMultiple){l.find('input[type="checkbox"]').prop("checked",(e,t)=>!t);const t=Boolean(this.$nativeSelect.find("optgroup").length),i=this._isToggleAllPresent()?l.index()-1:l.index();switch(!0){case this.isSearchable&&t:a=e(i-l.prevAll(".optgroup").length-1);break;case this.isSearchable:a=e(i-1);break;case t:a=e(i-l.prevAll(".optgroup").length);break;default:a=e(i);break}this._isToggleAllPresent()&&this._updateToggleAllOption(),this.$materialSelect.trigger("focus")}else{this.$materialOptionsList.find("li").removeClass("active").attr("aria-selected","false");const e=l.children().last()[0].childNodes[0];this.$materialSelect.val($(e).text().replace(/  +/g," ").trim()),this.$materialSelect.trigger("close")}l.toggleClass("active");const o=l.attr("aria-selected");l.attr("aria-selected","true"===o?"false":"true"),this._selectSingleOption(l),this.$nativeSelect.data("stop-refresh",!0);const n=this.$nativeSelect.attr("data-placeholder")?t+1:t;this.$nativeSelect.find("option").eq(n).prop("selected",a),this.$nativeSelect.removeData("stop-refresh"),this._triggerChangeOnNativeSelect(),this.$materialSelect.val()&&this.$mainLabel.addClass("active"),l.hasClass("li-added")&&this.renderer.buildSingleOption(l,"")})})}bindSingleMaterialOptionClick(){this.$materialOptionsList.find("li").on("click",()=>{this.$materialSelect.trigger("close")})}bindSearchInputKeyup(){this.$searchInput.find(".search").on("keyup",e=>{const t=$(e.target),i=e.which===this.keyCodes.tab,s=e.which===this.keyCodes.esc,l=e.which===this.keyCodes.enter,a=l&&e.shiftKey,o=e.which===this.keyCodes.arrowUp,n=e.which===this.keyCodes.arrowDown;if(n||i||s||o)return this.$materialSelect.focus(),void this._handleArrowUpDownKey(e.which);const r=t.closest("ul"),c=t.val(),h=r.find("li span.filtrable");let d=!1;if(h.each((function(){const e=$(this);if("string"===typeof this.outerHTML){const t=this.textContent.toLowerCase();t.includes(c.toLowerCase())?e.show().parent().show():e.hide().parent().hide(),t.trim()===c.toLowerCase()&&(d=!0)}})),l)return this.isEditable&&!d?void this.renderer.addNewOption():(a&&this._handleEnterWithShiftKey(t),void this.$materialSelect.trigger("open"));this.$addOptionBtn[c&&this.isEditable&&!d?"show":"hide"]();const p=0!==h.filter((e,t)=>$(t).is(":visible")&&!$(t).parent().hasClass("disabled")).length;p?(this.$toggleAll.show(),this.$materialOptionsList.find(this.$noSearchResultsInfo).remove(),this._updateToggleAllOption()):(this.$toggleAll.hide(),this.$materialOptionsList.append(this.$noSearchResultsInfo)),this.dropdown.updatePosition(this.$materialSelect,this.$materialOptionsList)})}bindHtmlClick(){$("html").on("click",e=>{$(e.target).closest("#select-options-"+this.properties.id).length||$(e.target).hasClass("mdb-select")||!$("#select-options-"+this.properties.id).hasClass("active")||(this.$materialSelect.trigger("close"),this.$materialSelect.val()||this.options.placeholder||this.$mainLabel.removeClass("active")),this.isSearchable&&null!==this.$searchInput&&this.$materialOptionsList.hasClass("active")&&this.$materialOptionsList.find(".search-wrap input.search").focus()})}bindMobileDevicesMousedown(){$("select").siblings("input.select-dropdown","input.multi-bs-select").on("mousedown",e=>{MaterialSelectView.isMobileDevice&&(e.clientX>=e.target.clientWidth||e.clientY>=e.target.clientHeight)&&e.preventDefault()})}bindSaveBtnClick(){this.$btnSave.on("click",()=>{this.$materialSelect.trigger("close")})}_toggleResetButton(e){const t=this.$nativeSelect.data("stop-refresh");this.$nativeSelect.attr("data-stop-refresh","true"),e?this.$nativeSelect.prepend('<option value="" selected disabled data-mdb-novalue></option>'):this.$nativeSelect.find("option[data-mdb-novalue]").remove(),this.$nativeSelect.attr("data-stop-refresh",t),this.$btnReset[e?"hide":"show"]()}_isToggleAllPresent(){return this.$materialOptionsList.find(this.$toggleAll).length}_updateToggleAllOption(){const e=this.$materialOptionsList.find("li").not(".select-toggle-all, .disabled, :hidden").find("[type=checkbox]"),t=e.filter(":checked"),i=this.$toggleAll.find("[type=checkbox]").is(":checked");t.length!==e.length||i?t.length<e.length&&i&&this.$toggleAll.find("[type=checkbox]").prop("checked",!1):this.$toggleAll.find("[type=checkbox]").prop("checked",!0)}_handleTabKey(e){this._handleEscKey(e)}_handleEnterWithShiftKey(e){this.isMultiple?this.$toggleAll.trigger("click"):this._handleEnterKey(e)}_handleEnterKey(e){const t=this.$materialOptionsList.find("li.selected:not(.disabled)");t.trigger("click").addClass("active"),this._removeKeyboardActiveClass(),this.isMultiple||e.trigger("close")}_handleArrowUpDownKey(e){const{$matchedMaterialOption:t,$activeOption:i}=this._getArrowMatchedActiveOptions(e,!1);this._selectSingleOption(t),this._removeKeyboardActiveClass(),t.find("input").is(":checked")||t.removeClass(this.options.keyboardActiveClass),i.hasClass("selected")||i.find("input").is(":checked")||!this.isMultiple||i.removeClass("active",this.options.keyboardActiveClass),t.addClass(this.options.keyboardActiveClass),t.position()&&this.$materialOptionsList.scrollTop(this.$materialOptionsList.scrollTop()+t.position().top)}_handleClosedArrowUpDownKey(e){const{$matchedMaterialOption:t}=this._getArrowMatchedActiveOptions(e,!0);t.trigger("click").addClass("active"),this._updateDropdownScrollTop(),this._selectSingleOption(t)}_getArrowMatchedActiveOptions(e,t){const i=t?"":":visible",s=this.$materialOptionsList.find("li"+i).not(".disabled, .select-toggle-all"),l=s.first(),a=s.last(),o=this.$materialOptionsList.find("li.selected").length>0;let n=null,r=null;const c=e===this.keyCodes.arrowUp;if(c){const e=o?this.$materialOptionsList.find("li.selected").first():a;let t=e.prev(`li${i}:not(.disabled, .select-toggle-all)`);r=t,s.each((e,i)=>{$(i).hasClass(this.options.keyboardActiveClass)&&(t=s.eq(e-1),r=s.eq(e))}),n=e.is(l)||!o?e:t}else{const e=o?this.$materialOptionsList.find("li.selected").first():l;let t=e.next(`li${i}:not(.disabled, .select-toggle-all)`);r=t,s.each((e,i)=>{$(i).hasClass(this.options.keyboardActiveClass)&&(t=s.eq(e+1),r=s.eq(e))}),n=e.is(a)||!o?e:t}return{$matchedMaterialOption:n,$activeOption:r}}_handleHomeKey(){this._selectBoundaryOption("first")}_handleEndKey(){this._selectBoundaryOption("last")}_selectBoundaryOption(e=""){const t=this.$materialOptionsList.find("li:visible").not(".disabled, .select-toggle-all")[e]();this._selectSingleOption(t),this._removeKeyboardActiveClass(),t.find("input").is(":checked")||t.removeClass(this.options.keyboardActiveClass),t.addClass(this.options.keyboardActiveClass),t.position()&&this.$materialOptionsList.scrollTop(this.$materialOptionsList.scrollTop()+t.position().top)}_handleEscKey(e){this._removeKeyboardActiveClass(),e.trigger("close")}_handleLetterKey(e){if(this._removeKeyboardActiveClass(),this.isSearchable){const t=e.which>46&&e.which<91,i=e.which>93&&e.which<106,s=8===e.which;(t||i)&&this.$searchInput.find("input").val(e.key).focus(),s&&this.$searchInput.find("input").val("").focus()}else{let t="";const i=String.fromCharCode(e.which).toLowerCase(),s=Object.keys(this.keyCodes).map(e=>this.keyCodes[e]),l=i&&-1===s.indexOf(e.which);if(l){t+=i;const e=this.$materialOptionsList.find("li").filter((e,i)=>$(i).text().toLowerCase().includes(t)).first();this.isMultiple||this.$materialOptionsList.find("li").removeClass("active"),e.addClass("active"),this._selectSingleOption(e),this._updateDropdownScrollTop()}}}_removeKeyboardActiveClass(){this.$materialOptionsList.find("li").removeClass(this.options.keyboardActiveClass)}_triggerChangeOnNativeSelect(){const e=new KeyboardEvent("change",{bubbles:!0,cancelable:!0});this.$nativeSelect.get(0).dispatchEvent(e)}_selectSingleOption(e){this.$materialOptionsList.find("li.selected").removeClass("selected"),this._selectOption(e)}_updateDropdownScrollTop(){const e=this.$materialOptionsList.find("li.active").not(".disabled").first();e.length?this.$materialOptionsList.scrollTo(e):this.$materialOptionsList.scrollTop(0)}_selectOption(e){const t=$(e);t.addClass("selected")}_copyOptions(e){return $.extend({},e)}_jQueryFallback(...e){let t=null;for(let i=0;i<e.length;i++)if(t=e[i],t.length)return t;return t}}